<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carjo Presupuestos</title>
    
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Carga de SheetJS (para leer .xlsx) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Metadatos para App Web Progresiva (PWA) -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Carjo">
    <meta name="theme-color" content="#F9A825">
    
    <!-- Favicon (generado a partir del logo) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22%23F9A825%22></circle><path d=%22M75 35H25a5 5 0 0 0-5 5v30a5 5 0 0 0 5 5h50a5 5 0 0 0 5-5V40a5 5 0 0 0-5-5zM30 48h40v-8H30zM30 58h40v-8H30zM50 25l25 10H25l25-10z%22 fill=%22%23ffffff%22></path></svg>">
    
    <!-- Manifiesto PWA (generado dinámicamente) -->
    <link rel="manifest" id="app-manifest">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        #file-upload-label {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            background-color: #F9A825; /* Naranja del logo */
        }
        #file-upload-label:hover {
            opacity: 0.9;
            background-color: #E6951A;
        }
        #file-input {
            display: none;
        }
        
        /* Aumento de padding-bottom para que el footer no tape la lista */
        #product-list {
            padding-bottom: 22rem; /* Aumentado de 12rem a 22rem */
        }
        
        .qty-btn {
            width: 2.25rem;
            height: 2.25rem;
            border-radius: 9999px;
            color: white;
            font-weight: bold;
            font-size: 1.5rem;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
            -webkit-user-select: none;
            user-select: none;
        }
        .qty-btn:active {
            opacity: 0.7;
        }
        .qty-btn.bg-red-500 { background-color: #EF4444; }
        .qty-btn.bg-green-600 { background-color: #22C55E; }
        .qty-btn.bg-green-600:hover { background-color: #16A34A; }

        /* Estilos para el modal de confirmación */
        #confirm-modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }

        /* Estilos para censurar el beneficio */
        #profit-box.censored > #total-profit {
            filter: blur(6px);
            transition: filter 0.2s;
            user-select: none;
        }
        #profit-box:not(.censored) > #total-profit {
            filter: blur(0);
            transition: filter 0.2s;
        }
        
        /* Estilos para el modal de Ficha de Producto */
        #product-modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }

    </style>
</head>
<body class="bg-gray-100">

    <!-- 1. PANTALLA DE IMPORTACIÓN -->
    <div id="import-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center">
            
            <div class="mb-4">
                <img src="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22%23F9A825%22></circle><path d=%22M75 35H25a5 5 0 0 0-5 5v30a5 5 0 0 0 5 5h50a5 5 0 0 0 5-5V40a5 5 0 0 0-5-5zM30 48h40v-8H30zM30 58h40v-8H30zM50 25l25 10H25l25-10z%22 fill=%22%23ffffff%22></path></svg>" 
                     alt="Carjo Presupuestos Logo" class="w-24 h-24 mx-auto mb-4">
            </div>
            <h1 class="text-2xl font-bold text-gray-800 mb-4">Carjo Presupuestos</h1>
            <p class="text-gray-600 mb-6">Sube tu archivo .CSV o .XLSX de productos para empezar.</p>

            <label for="file-input" id="file-upload-label" class="w-full text-white font-semibold py-3 px-6 rounded-lg shadow-md inline-block hover:bg-opacity-90">
                Importar Archivo .CSV / .XLSX
            </label>
            <input type="file" id="file-input" accept=".csv,.xlsx,.xls">

            <p id="error-message" class="text-red-500 text-sm mt-4 hidden"></p>
        </div>
    </div>

    <!-- 2. PANTALLA DE LA CALCULADORA -->
    <div id="calculator-screen" class="hidden flex flex-col min-h-screen">
        
        <!-- Cabecera -->
        <header class="bg-white shadow-md p-4 sticky top-0 z-10 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800">Seleccionar Productos</h1>
            <button id="clear-data-button" class="bg-[#F9A825] text-white font-semibold py-2 px-4 rounded-lg shadow-md text-sm hover:bg-[#E6951A] transition-colors">
                Cargar Nuevo
            </button>
        </header>

        <!-- Buscador -->
        <div class="p-4 bg-white border-b border-gray-200">
            <input type="text" id="search-box" placeholder="Buscar producto..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#F9A825]">
        </div>

        <!-- Lista de Productos -->
        <main id="product-list" class="flex-1 p-4 flex flex-col gap-3">
            <!-- Los productos se inyectan aquí con JS -->
        </main>

        <!-- Pie de página (Resumen y Totales) -->
        <footer class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg p-4 z-10">
            
            <!-- Lista del Carrito (desplegable) -->
            <div id="cart-items" class="max-h-32 overflow-y-auto mb-4 text-sm text-gray-700">
                <p id="cart-placeholder" class="text-gray-400 text-center">El carrito está vacío</p>
            </div>
            
            <!-- Resumen de Totales (cuadrícula 2x2) -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="text-center">
                    <span class="block text-xs font-medium text-gray-500 uppercase">Total (Base)</span>
                    <span id="total-price" class="block text-lg font-bold text-blue-600">0.00 €</span>
                </div>
                 <div class="text-center">
                    <span class="block text-xs font-medium text-gray-500 uppercase">Total (IVA incl.)</span>
                    <span id="total-price-vat" class="block text-lg font-bold text-gray-900">0.00 €</span>
                </div>
                <div id="profit-box" class="text-center cursor-pointer censored">
                    <span class="block text-xs font-medium text-gray-500 uppercase">Beneficio (tocar para ver)</span>
                    <span id="total-profit" class="block text-lg font-bold text-green-600">0.00 €</span>
                </div>
                <div class="text-center">
                    <span class="block text-xs font-medium text-gray-500 uppercase">Items</span>
                    <span id="total-items" class="block text-lg font-bold text-gray-800">0</span>
                </div>
            </div>

            <!-- Botón Limpiar Carrito -->
            <button id="reset-button" class="w-full bg-red-500 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-red-600 transition-colors">
                Limpiar Carrito
            </button>
        </footer>
    </div>
    
    <!-- 3. MODAL DE CONFIRMACIÓN (para "Cargar Nuevo") -->
    <div id="confirm-modal-overlay" class="fixed inset-0 z-20 flex items-center justify-center p-4 hidden">
        <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm">
            <h2 class="text-lg font-bold text-gray-900 mb-4">¿Estás seguro?</h2>
            <p class="text-gray-600 mb-6">Si cargas un nuevo archivo, se borrarán todos los productos y el carrito actual.</p>
            <div class="flex justify-end gap-3">
                <button id="cancel-clear-button" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">
                    Cancelar
                </button>
                <button id="confirm-clear-button" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600">
                    Sí, Cargar Nuevo
                </button>
            </div>
        </div>
    </div>

    <!-- 4. MODAL DE FICHA DE PRODUCTO -->
    <div id="product-modal-overlay" class="fixed inset-0 z-30 flex items-center justify-center p-4 hidden">
        <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-lg max-h-[80vh] flex flex-col">
            <!-- Contenido de la ficha -->
            <div id="product-modal-content" class="flex-1 overflow-y-auto">
                <!-- El contenido se inyecta con JS -->
            </div>
            
            <!-- Botón de cerrar -->
            <button id="close-modal-button" class="mt-6 w-full bg-gray-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-gray-700 transition-colors">
                Cerrar
            </button>
        </div>
    </div>


    <script>
        // --- 1. REFERENCIAS A ELEMENTOS DEL DOM ---
        const importScreen = document.getElementById('import-screen');
        const calculatorScreen = document.getElementById('calculator-screen');
        const fileInput = document.getElementById('file-input');
        const productList = document.getElementById('product-list');
        const searchBox = document.getElementById('search-box');
        const errorMessage = document.getElementById('error-message');
        const clearDataButton = document.getElementById('clear-data-button');
        
        const cartItemsContainer = document.getElementById('cart-items');
        const cartPlaceholder = document.getElementById('cart-placeholder');
        const totalPriceEl = document.getElementById('total-price');
        const totalPriceVatEl = document.getElementById('total-price-vat');
        const totalProfitEl = document.getElementById('total-profit');
        const totalItemsEl = document.getElementById('total-items');
        const profitBox = document.getElementById('profit-box');
        const resetButton = document.getElementById('reset-button');
        const appManifest = document.getElementById('app-manifest');

        // Modal de Confirmación
        const confirmModalOverlay = document.getElementById('confirm-modal-overlay');
        const cancelClearButton = document.getElementById('cancel-clear-button');
        const confirmClearButton = document.getElementById('confirm-clear-button');

        // Modal de Ficha de Producto
        const productModalOverlay = document.getElementById('product-modal-overlay');
        const productModalContent = document.getElementById('product-modal-content');
        const closeModalButton = document.getElementById('close-modal-button');

        // --- 2. ESTADO DE LA APLICACIÓN ---
        let allProducts = []; // Guarda todos los productos del Excel
        let cart = {}; // Guarda los productos seleccionados { productId: quantity }
        const VAT_RATE = 0.21; // 21% de IVA

        // --- 3. LÓGICA DE INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', initializeApp);

        function initializeApp() {
            // Generar el manifiesto de la PWA dinámicamente
            const manifest = {
                "name": "Carjo Presupuestos",
                "short_name": "Carjo",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#f3f4f6",
                "theme_color": "#F9A825",
                "description": "Calculadora de presupuestos a partir de un Excel.",
                "icons": [
                    {
                        "src": "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22%23F9A825%22></circle><path d=%22M75 35H25a5 5 0 0 0-5 5v30a5 5 0 0 0 5 5h50a5 5 0 0 0 5-5V40a5 5 0 0 0-5-5zM30 48h40v-8H30zM30 58h40v-8H30zM50 25l25 10H25l25-10z%22 fill=%22%23ffffff%22></path></svg>",
                        "sizes": "192x192",
                        "type": "image/svg+xml"
                    }
                ]
            };
            const manifestString = JSON.stringify(manifest);
            appManifest.href = 'data:application/json;base64,' + btoa(unescape(encodeURIComponent(manifestString)));

            // Asignar listeners
            fileInput.addEventListener('change', handleFileSelect);
            resetButton.addEventListener('click', resetCalculator);
            searchBox.addEventListener('input', filterProducts);
            profitBox.addEventListener('click', toggleProfitVisibility);
            
            // Listeners del modal de confirmación
            clearDataButton.addEventListener('click', () => confirmModalOverlay.classList.remove('hidden'));
            cancelClearButton.addEventListener('click', () => confirmModalOverlay.classList.add('hidden'));
            confirmClearButton.addEventListener('click', clearAllData);
            
            // Listeners del modal de ficha de producto
            closeModalButton.addEventListener('click', () => productModalOverlay.classList.add('hidden'));
            productModalOverlay.addEventListener('click', (e) => {
                // Cierra si se hace clic en el fondo oscuro
                if (e.target === productModalOverlay) {
                    productModalOverlay.classList.add('hidden');
                }
            });

            // Comprobar si hay productos guardados
            const savedProducts = localStorage.getItem('allProducts');
            const savedCart = localStorage.getItem('cart');

            if (savedProducts) {
                try {
                    allProducts = JSON.parse(savedProducts);
                    
                    if (savedCart) {
                        cart = JSON.parse(savedCart);
                    }
                    
                    displayProducts(allProducts); // Mostrar productos antes de actualizar el resumen
                    updateSummary(); // Actualizar carrito y totales

                    // Saltar la pantalla de importación
                    importScreen.classList.add('hidden');
                    calculatorScreen.classList.remove('hidden');
                    calculatorScreen.classList.add('flex');
                } catch (e) {
                    console.error("Error al parsear datos de localStorage", e);
                    clearAllData(); // Si hay error, limpiar todo
                }
            }
        }
        
        // --- 4. LÓGICA DE LECTURA DE ARCHIVO ---

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.endsWith('.csv') && !file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                showError('Por favor, sube un archivo .csv o .xlsx');
                return;
            }
            
            errorMessage.classList.add('hidden');
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    parseData(jsonData);

                } catch (err) {
                    console.error(err);
                    showError('Error al procesar el archivo.');
                }
            };
            
            reader.onerror = function() {
                showError('No se pudo leer el archivo.');
            };
            
            reader.readAsArrayBuffer(file);
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function parseData(data) {
            allProducts = [];
            if (data.length < 2) {
                showError('El archivo está vacío o no tiene datos.');
                return;
            }

            const header = data[0].map(h => String(h).toLowerCase().trim());
            
            // Columnas requeridas
            const nameIndex = header.indexOf('componente');
            const priceIndex = header.indexOf('precio pvp (€)');
            const costIndex = header.indexOf('coste tras descuentos');

            // Columnas opcionales (para la ficha de producto)
            const descIndex = header.indexOf('descripción');
            const brandIndex = header.indexOf('fabricante');
            const catIndex = header.indexOf('categoría');
            const imgIndex = header.indexOf('imagen_fabricante'); // <-- AÑADIDA

            if (nameIndex === -1 || priceIndex === -1 || costIndex === -1) {
                let missing = [];
                if (nameIndex === -1) missing.push('"componente"');
                if (priceIndex === -1) missing.push('"precio pvp (€)"');
                if (costIndex === -1) missing.push('"coste tras descuentos"');
                showError(`Faltan columnas requeridas: ${missing.join(', ')}.`);
                return;
            }

            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length === 0) continue;

                const nombre = row[nameIndex];
                const precioVenta = parseFloat(row[priceIndex]);
                const costo = parseFloat(row[costIndex]);

                if (nombre && !isNaN(precioVenta) && !isNaN(costo)) {
                    allProducts.push({
                        id: `prod-${i}`,
                        nombre: String(nombre).trim(),
                        precio: precioVenta,
                        costo: costo,
                        // Añadimos datos opcionales
                        descripcion: descIndex > -1 ? String(row[descIndex] || '').trim() : '',
                        fabricante: brandIndex > -1 ? String(row[brandIndex] || '').trim() : '',
                        categoria: catIndex > -1 ? String(row[catIndex] || '').trim() : '',
                        imagen: imgIndex > -1 ? String(row[imgIndex] || '').trim() : '' // <-- AÑADIDA
                    });
                }
            }

            localStorage.setItem('allProducts', JSON.stringify(allProducts));
            
            // Limpiar carrito al cargar nuevo archivo
            cart = {};
            localStorage.removeItem('cart');

            displayProducts(allProducts);
            updateSummary(); // Actualizar totales (que estarán a 0)

            importScreen.classList.add('hidden');
            calculatorScreen.classList.remove('hidden');
            calculatorScreen.classList.add('flex');
        }

        // --- 5. LÓGICA DE RENDERIZADO (VISTAS) ---

        function displayProducts(productsToDisplay) {
            productList.innerHTML = '';
            
            if (productsToDisplay.length === 0) {
                productList.innerHTML = '<p class="col-span-full text-center text-gray-500">No se encontraron productos.</p>';
                return;
            }

            productsToDisplay.forEach(product => {
                const card = document.createElement('div');
                // AÑADIDA IMAGEN: volvemos al flex con gap
                card.className = "bg-white p-4 rounded-lg shadow-md flex items-center gap-4";
                
                const quantity = cart[product.id] || 0;
                const priceWithVat = product.precio * (1 + VAT_RATE);
                
                // Icono por defecto si no hay imagen
                // (Usamos un SVG simple como placeholder)
                const imageHtml = product.imagen
                    ? `<img src="${product.imagen}" alt="${product.nombre}" class="w-14 h-14 object-contain rounded-md bg-gray-100" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 fill=%22none%22 viewBox=%220 0 24 24%22 stroke-width=%221.5%22 stroke=%22currentColor%22 class=%22w-6 h-6 text-gray-400%22%3E%3Cpath stroke-linecap=%22round%22 stroke-linejoin=%22round%22 d=%22m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm1.5-6.75h.008v.008H4.5v-.008Z%22 /%3E%3C/svg%3E'; this.onerror=null; this.classList.add('p-4');" />`
                    : `<div class="w-14 h-14 rounded-md bg-gray-100 flex items-center justify-center text-gray-400 flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm1.5-6.75h.008v.008H4.5v-.008Z" /></svg>
                       </div>`;

                card.innerHTML = `
                    ${imageHtml}
                    <div class="flex-1 min-w-0">
                        <a href="#" class="block font-semibold text-gray-800 text-md truncate hover:underline" onclick="showProductModal(event, '${product.id}')">
                            ${product.nombre}
                        </a>
                        <div class"mt-1">
                            <p class="text-blue-600 font-semibold text-xs">
                                ${product.precio.toFixed(2)} € <span class="text-gray-500 font-normal">(Base)</span>
                            </p>
                            <p class="text-gray-900 font-bold text-md">
                                ${priceWithVat.toFixed(2)} € <span class="text-gray-600 font-normal text-xs">(IVA incl.)</span>
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button class="qty-btn bg-red-500" onclick="decrementQuantity(event, '${product.id}')">-</button>
                        <span id="qty-${product.id}" class="font-bold text-lg w-8 text-center">${quantity}</span>
                        <button class="qty-btn bg-green-600" onclick="incrementQuantity(event, '${product.id}')">+</button>
                    </div>
                `;
                
                productList.appendChild(card);
            });
        }

        function filterProducts() {
            const query = searchBox.value.toLowerCase();
            const filteredProducts = allProducts.filter(product => 
                product.nombre.toLowerCase().includes(query)
            );
            displayProducts(filteredProducts);
        }
        
        function showProductModal(event, productId) {
            event.preventDefault(); // Evitar que el enlace "#" mueva la página
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;
            
            const priceWithVat = product.precio * (1 + VAT_RATE);
            
            // Info de Fabricante y Categoría (si existen)
            let detailsHtml = '';
            if (product.fabricante) {
                detailsHtml += `<p class="text-md text-gray-600 mb-1"><span class="font-semibold">Fabricante:</span> ${product.fabricante}</p>`;
            }
            if (product.categoria) {
                detailsHtml += `<p class="text-md text-gray-600 mb-4"><span class="font-semibold">Categoría:</span> ${product.categoria}</p>`;
            }

            // AÑADIDA IMAGEN: Placeholder para la ficha
            const imageHtml = product.imagen
                ? `<img src="${product.imagen}" alt="${product.nombre}" class="w-full h-48 object-contain rounded-lg bg-gray-100 mb-4" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 fill=%22none%22 viewBox=%220 0 24 24%22 stroke-width=%221.5%22 stroke=%22currentColor%22 class=%22w-6 h-6 text-gray-400%22%3E%3Cpath stroke-linecap=%22round%22 stroke-linejoin=%22round%22 d=%22m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm1.5-6.75h.008v.008H4.5v-.008Z%22 /%3E%3C/svg%3E'; this.onerror=null; this.classList.add('p-12');" />`
                : `<div class="w-full h-48 rounded-lg bg-gray-100 flex items-center justify-center text-gray-400 mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm1.5-6.75h.008v.008H4.5v-.008Z" /></svg>
                   </div>`;


            productModalContent.innerHTML = `
                ${imageHtml}
                <h2 class="text-2xl font-bold text-gray-900 mb-2">${product.nombre}</h2>
                
                ${detailsHtml}
                
                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                    <p class="text-blue-600 font-semibold text-sm">
                        ${product.precio.toFixed(2)} € <span class="text-gray-500 font-normal">(Base)</span>
                    </p>
                    <p class="text-gray-900 font-bold text-lg">
                        ${priceWithVat.toFixed(2)} € <span class="text-gray-600 font-normal text-sm">(IVA incl.)</span>
                    </p>
                </div>
                
                ${product.descripcion ? `
                    <h3 class="font-semibold text-gray-800 mb-2">Descripción</h3>
                    <p class="text-gray-600 whitespace-pre-wrap">${product.descripcion}</p>
                ` : ''}
            `;
            productModalOverlay.classList.remove('hidden');
        }


        // --- 6. LÓGICA DEL CARRITO ---

        function incrementQuantity(event, productId) {
            event.stopPropagation();
            const currentQty = cart[productId] || 0;
            cart[productId] = currentQty + 1;
            
            updateQuantityUI(productId);
            updateSummary();
        }

        function decrementQuantity(event, productId) {
            event.stopPropagation();
            const currentQty = cart[productId] || 0;
            
            if (currentQty > 0) {
                cart[productId] = currentQty - 1;
                if (cart[productId] === 0) {
                    delete cart[productId];
                }
            }
            
            updateQuantityUI(productId);
            updateSummary();
        }

        function updateQuantityUI(productId) {
            const qtyEl = document.getElementById(`qty-${productId}`);
            if (qtyEl) {
                qtyEl.textContent = cart[productId] || 0;
            }
        }

        function updateSummary() {
            let totalPrice = 0;
            let totalCost = 0;
            let totalItems = 0;

            cartItemsContainer.innerHTML = '';
            if (Object.keys(cart).length === 0) {
                cartItemsContainer.appendChild(cartPlaceholder);
                cartPlaceholder.classList.remove('hidden');
            } else {
                cartPlaceholder.classList.add('hidden');
                
                for (const productId in cart) {
                    const quantity = cart[productId];
                    if (quantity === 0) continue;

                    const product = allProducts.find(p => p.id === productId);
                    if (!product) continue;

                    totalPrice += product.precio * quantity;
                    totalCost += product.costo * quantity;
                    totalItems += quantity;

                    const itemPriceVat = (product.precio * quantity) * (1 + VAT_RATE);

                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex justify-between items-center py-1 px-2 even:bg-gray-50 rounded';
                    itemEl.innerHTML = `
                        <span class="flex-1 min-w-0 pr-2">
                            <span class="font-semibold text-blue-600">${quantity}x</span> 
                            <span class="truncate">${product.nombre}</span>
                        </span>
                        <span class="font-medium text-right">
                            <span class="block text-blue-600 text-xs">${(product.precio * quantity).toFixed(2)} € <span class="text-gray-500">(Base)</span></span>
                            <span class="block text-gray-900 text-sm font-semibold">${itemPriceVat.toFixed(2)} € <span class="text-gray-600 text-xs">(IVA incl.)</span></span>
                        </span>
                    `;
                    cartItemsContainer.appendChild(itemEl);
                }
            }

            const totalProfit = totalPrice - totalCost;
            const totalPriceWithVat = totalPrice * (1 + VAT_RATE);

            totalPriceEl.textContent = `${totalPrice.toFixed(2)} €`;
            totalPriceVatEl.textContent = `${totalPriceWithVat.toFixed(2)} €`;
            totalProfitEl.textContent = `${totalProfit.toFixed(2)} €`;
            totalItemsEl.textContent = totalItems;

            try {
                localStorage.setItem('cart', JSON.stringify(cart));
            } catch (e) {
                console.error("Error al guardar el carrito en localStorage", e);
            }
        }

        function resetCalculator() {
            cart = {};
            localStorage.removeItem('cart');
            updateSummary();
            filterProducts(); // Actualiza la UI de la lista de productos (pone contadores a 0)
            profitBox.classList.add('censored'); // Vuelve a censurar el beneficio
        }

        function clearAllData() {
            localStorage.removeItem('allProducts');
            localStorage.removeItem('cart');
            location.reload(); // Recarga la app a la pantalla de importación
        }
        
        function toggleProfitVisibility() {
            profitBox.classList.toggle('censored');
        }
    </script>
</body>
</html>

