<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carjo Presupuestos</title>
    
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Carga de SheetJS (para leer .xlsx) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Metadatos para App Web Progresiva (PWA) -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Carjo">
    <meta name="theme-color" content="#F9A825">
    
    <!-- Favicon (generado a partir del logo) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22%23F9A825%22></circle><path d=%22M75 35H25a5 5 0 0 0-5 5v30a5 5 0 0 0 5 5h50a5 5 0 0 0 5-5V40a5 5 0 0 0-5-5zM30 48h40v-8H30zM30 58h40v-8H30zM50 25l25 10H25l25-10z%22 fill=%22%23ffffff%22></path></svg>">
    
    <!-- Manifiesto PWA (generado dinámicamente) -->
    <link rel="manifest" id="app-manifest">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Fondo gris claro para la app */
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        #file-upload-label {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            background-color: #F9A825; /* Naranja del logo */
        }
        #file-upload-label:hover {
            opacity: 0.9;
            background-color: #E6951A;
        }
        #file-input {
            display: none;
        }
        
        #product-list {
            padding-bottom: 22rem; 
        }
        
        .qty-btn {
            width: 2.25rem;
            height: 2.25rem;
            border-radius: 9999px;
            color: white;
            font-weight: bold;
            font-size: 1.5rem;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
            -webkit-user-select: none;
            user-select: none;
        }
        .qty-btn:active {
            opacity: 0.7;
        }
        .qty-btn.bg-red-500 { background-color: #EF4444; }
        .qty-btn.bg-green-600 { background-color: #22C55E; }
        .qty-btn.bg-green-600:hover { background-color: #16A43A; }

        /* Estilos para el modal de confirmación */
        #confirm-modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }

        /* Estilos para censurar el beneficio */
        #profit-box.censored > #total-profit {
            filter: blur(6px);
            transition: filter 0.2s;
            user-select: none;
        }
        #profit-box:not(.censored) > #total-profit {
            filter: blur(0);
            transition: filter 0.2s;
        }
        
        /* Estilos para el modal de Ficha de Producto */
        #product-modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        /* --- ESTILOS MEJORADOS PARA EL PRESUPUESTO --- */
        #budget-preview-modal-overlay {
            background-color: rgba(0, 0, 0, 0.75);
        }
        
        #budget-sheet {
            /* CAMBIO: Ancho responsive */
            width: 100%; /* Ocupa el 100% del modal, que tiene max-w-4xl */
            min-height: 0; /* Quitamos la altura mínima de A4 */
            padding: 1.5rem; /* Padding para móvil */
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            background-color: #ffffff; /* Fondo blanco para la hoja */
            color: #333; /* Color de texto base */
        }
        /* En pantallas grandes (PC), simulamos el A4 */
        @media (min-width: 1024px) {
            #budget-sheet {
                width: 210mm;
                min-height: 297mm;
                padding: 15mm;
            }
        }
        
        /* Estilos MEJORADOS para la tabla del presupuesto */
        #budget-table {
            width: 100%;
            border-collapse: collapse; /* Quitamos espacios entre bordes */
            margin-top: 25px;
            font-size: 13px; /* Aumentamos tamaño de fuente base de la tabla */
        }
        #budget-table th {
            /* Cabecera con color de marca */
            background-color: #F9A825;
            color: white;
            padding: 12px 15px; /* Más espaciado */
            text-align: left;
            font-weight: 600; /* Semigrueso */
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
            border: none; /* Sin bordes en la cabecera */
        }
        #budget-table td {
            border: none; /* Sin bordes laterales */
            border-bottom: 1px solid #eee; /* Solo borde inferior */
            padding: 12px 15px; /* Más espaciado */
            vertical-align: top; 
        }
        /* Color de la última fila de la tabla */
        #budget-table tr:last-child td {
            border-bottom: none;
        }
        
        #budget-table td.text-right, #budget-table th.text-right {
            text-align: right;
        }

        /* Contenedor de totales MEJORADO */
        .budget-totals-container {
            width: 100%; /* Ancho completo en móvil */
            margin-left: auto; /* Alineado a la derecha */
            margin-top: 25px;
            font-size: 14px;
        }
        /* En PC, más estrecho y a la derecha */
        @media (min-width: 640px) {
            .budget-totals-container {
                width: 50%;
            }
        }

        .totals-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .totals-row span:last-child {
            font-weight: 600;
            color: #111;
        }
        /* Fila final de TOTAL (IVA incl.) MEJORADA */
        .totals-row.final {
            margin-top: 10px;
            padding: 14px;
            background-color: #F9A825; /* Color de marca */
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 8px; /* Bordes redondeados */
            border-bottom: none;
        }
        .totals-row.final span:last-child {
            color: white;
        }

        /* Pie de página para el presupuesto */
        .budget-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
            font-size: 11px;
            color: #777;
        }
        .budget-footer p {
            margin: 0 0 5px 0;
        }
        
        /* --- FIN ESTILOS MEJORADOS --- */
        
        #client-info-modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        /* Ocultar en la impresión */
        @media print {
            body {
                background-color: #fff;
            }
            #app-controls, #calculator-screen { /* Ocultar app e imprimir controles */
                display: none;
            }
            #budget-preview-modal-overlay {
                /* Asegurarse de que el modal de previo ocupe todo */
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: #fff;
                padding: 0;
                margin: 0;
                overflow: visible;
            }
            #budget-sheet {
                box-shadow: none;
                padding: 0;
                margin: 0;
                width: 100%;
                min-height: auto;
                color: #000; /* Asegurar texto negro en impresión */
                border: none;
            }
            /* CAMBIO: Forzar impresión de colores */
            #budget-table th {
                background-color: #F9A825 !important;
                color: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .totals-row.final {
                background-color: #F9A825 !important;
                color: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }

    </style>
</head>
<body class="bg-gray-100">

    <!-- 1. PANTALLA DE IMPORTACIÓN -->
    <div id="import-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center">
            
            <div class="mb-4">
                <img src="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22%23F9A825%22></circle><path d=%22M75 35H25a5 5 0 0 0-5 5v30a5 5 0 0 0 5 5h50a5 5 0 0 0 5-5V40a5 5 0 0 0-5-5zM30 48h40v-8H30zM30 58h40v-8H30zM50 25l25 10H25l25-10z%22 fill=%22%23ffffff%22></path></svg>" 
                     alt="Carjo Presupuestos Logo" class="w-24 h-24 mx-auto mb-4">
            </div>
            <h1 class="text-2xl font-bold text-gray-800 mb-4">Carjo Presupuestos</h1>
            <p class="text-gray-600 mb-6">Sube tu archivo .CSV o .XLSX de productos para empezar.</p>

            <label for="file-input" id="file-upload-label" class="w-full text-white font-semibold py-3 px-6 rounded-lg shadow-md inline-block hover:bg-opacity-90">
                Importar Archivo .CSV / .XLSX
            </label>
            <input type="file" id="file-input" accept=".csv,.xlsx,.xls">

            <p id="error-message" class="text-red-500 text-sm mt-4 hidden"></p>
        </div>
    </div>

    <!-- 2. PANTALLA DE LA CALCULADORA -->
    <div id="calculator-screen" class="hidden flex flex-col min-h-screen">
        
        <!-- Cabecera -->
        <header class="bg-white shadow-md p-4 sticky top-0 z-10 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800">Seleccionar Productos</h1>
            <button id="clear-data-button" class="bg-[#F9A825] text-white font-semibold py-2 px-4 rounded-lg shadow-md text-sm hover:bg-[#E6951A] transition-colors">
                Cargar Nuevo
            </button>
        </header>

        <!-- Buscador -->
        <div class="p-4 bg-white border-b border-gray-200">
            <input type="text" id="search-box" placeholder="Buscar por producto, categoría o fabricante..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#F9A825]">
        </div>

        <!-- Lista de Productos -->
        <main id="product-list" class="flex-1 p-4 flex flex-col gap-3">
            <!-- Los productos se inyectan aquí con JS -->
        </main>

        <!-- Pie de página (Resumen y Totales) -->
        <footer class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg p-4 z-10">
            
            <!-- Lista del Carrito (desplegable) -->
            <div id="cart-items" class="max-h-32 overflow-y-auto mb-4 text-sm text-gray-700">
                <p id="cart-placeholder" class="text-gray-400 text-center">El carrito está vacío</p>
            </div>
            
            <!-- Resumen de Totales (cuadrícula 2x2) -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="text-center">
                    <span class="block text-xs font-medium text-gray-500 uppercase">Total (Base)</span>
                    <span id="total-price" class="block text-lg font-bold text-blue-600">0.00 €</span>
                </div>
                 <div class="text-center">
                    <span class="block text-xs font-medium text-gray-500 uppercase">Total (IVA incl.)</span>
                    <span id="total-price-vat" class="block text-lg font-bold text-gray-900">0.00 €</span>
                </div>
                <div id="profit-box" class="text-center cursor-pointer censored">
                    <span class="block text-xs font-medium text-gray-500 uppercase">Beneficio (tocar para ver)</span>
                    <span id="total-profit" class="block text-lg font-bold text-green-600">0.00 €</span>
                </div>
                <div class="text-center">
                    <span class="block text-xs font-medium text-gray-500 uppercase">Items</span>
                    <span id="total-items" class="block text-lg font-bold text-gray-800">0</span>
                </div>
            </div>

            <!-- Botones del pie de página -->
            <div class="flex items-center">
                <!-- Botón Limpiar Carrito (Icono) -->
                <button id="reset-button" class="bg-red-500 text-white font-semibold p-3 rounded-lg shadow-md hover:bg-red-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M16.5 4.478v.227a48.816 48.816 0 0 1 3.878.512.75.75 0 1 1-.256 1.478l-.209-.035-1.005 13.07a3 3 0 0 1-2.991 2.77H8.084a3 3 0 0 1-2.991-2.77L4.087 6.66l-.209.035a.75.75 0 0 1-.256-1.478A48.567 48.567 0 0 1 7.5 4.705v-.227c0-1.564 1.213-2.9 2.816-2.951a52.662 52.662 0 0 1 3.369 0c1.603.051 2.816 1.387 2.816 2.951Zm-6.136-1.452a51.196 51.196 0 0 0-3.369 0c-.37.012-.63.29-.63.64v.227h4.639v-.227c0-.35-.26-.628-.63-.64Z" clip-rule="evenodd" />
                        <path fill-rule="evenodd" d="M5.082 6.975c.04.052.08.105.12.158l.823 10.718a1.5 1.5 0 0 0 1.492 1.396h7.962a1.5 1.5 0 0 0 1.492-1.396l.823-10.718c.04-.053.08-.106.12-.158H5.082Z" clip-rule="evenodd" />
                    </svg>
                </button>
                
                <!-- Botón Generar Presupuesto -->
                <button id="generate-budget-button" class="flex-1 bg-[#F9A825] text-white font-semibold py-3 rounded-lg shadow-md hover:bg-[#E6951A] transition-colors ml-3">
                    Generar Presupuesto
                </button>
            </div>
        </footer>
    </div>
    
    <!-- 3. MODAL DE CONFIRMACIÓN (para "Cargar Nuevo") -->
    <div id="confirm-modal-overlay" class="fixed inset-0 z-20 flex items-center justify-center p-4 hidden">
        <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm">
            <h2 class="text-lg font-bold text-gray-900 mb-4">¿Estás seguro?</h2>
            <p class="text-gray-600 mb-6">Si cargas un nuevo archivo, se borrarán todos los productos y el carrito actual.</p>
            <div class="flex justify-end gap-3">
                <button id="cancel-clear-button" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">
                    Cancelar
                </button>
                <button id="confirm-clear-button" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600">
                    Sí, Cargar Nuevo
                </button>
            </div>
        </div>
    </div>

    <!-- 4. MODAL DE FICHA DE PRODUCTO -->
    <div id="product-modal-overlay" class="fixed inset-0 z-30 flex items-center justify-center p-4 hidden">
        <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-lg max-h-[80vh] flex flex-col">
            <!-- Contenido de la ficha -->
            <div id="product-modal-content" class="flex-1 overflow-y-auto">
                <!-- El contenido se inyecta con JS -->
            </div>
            
            <!-- Botón de cerrar -->
            <button id="close-modal-button" class="mt-6 w-full bg-gray-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-gray-700 transition-colors">
                Cerrar
            </button>
        </div>
    </div>

    <!-- 5. MODAL DE PREVIO DE PRESUPUESTO -->
    <div id="budget-preview-modal-overlay" class="fixed inset-0 z-40 flex items-center justify-center p-4 hidden overflow-y-auto">
        <div class="relative w-full max-w-4xl my-8">
            <!-- Controles (Cerrar, Imprimir, etc.) -->
            <div id="app-controls" class="bg-gray-800 text-white p-4 rounded-t-lg flex justify-between items-center sticky top-0">
                <div>
                    <h3 class="text-lg font-semibold">Previo de Presupuesto</h3>
                    <p class="text-sm text-gray-300">¡Listo! Haz una captura de pantalla o imprime.</p>
                </div>
                <div>
                    <button id="print-budget-button" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg mr-2">
                        Imprimir / Guardar PDF
                    </button>
                    <button id="close-budget-preview-button" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg">
                        Cerrar
                    </button>
                </div>
            </div>
            
            <!-- La "hoja" del presupuesto -->
            <div id="budget-sheet" class="bg-white text-black p-8">
                <!-- El contenido se inyecta con JS -->
            </div>
        </div>
    </div>
    
    <!-- 6. MODAL DE INFORMACIÓN DEL CLIENTE (ANTES DEL PREVIO) -->
    <div id="client-info-modal-overlay" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm">
            <h2 class="text-lg font-bold text-gray-900 mb-4">Detalles del Presupuesto</h2>
            
            <!-- Nombre del Cliente -->
            <div class="mb-4">
                <label for="client-name-input" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Cliente</label>
                <input type="text" id="client-name-input" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#F9A825]" placeholder="Ej: Juan Pérez">
            </div>
            
            <!-- Tipo de IVA -->
            <div class="mb-6">
                <span class="block text-sm font-medium text-gray-700 mb-2">Tipo de IVA</span>
                <div class="flex gap-4">
                    <label for="iva-21" class="flex items-center">
                        <input type="radio" id="iva-21" name="iva-type" value="0.21" class="focus:ring-[#F9A825] h-4 w-4 text-[#F9A825] border-gray-300" checked>
                        <span class="ml-2 text-gray-700">Empresa (21%)</span>
                    </label>
                    <label for="iva-10" class="flex items-center">
                        <input type="radio" id="iva-10" name="iva-type" value="0.10" class="focus:ring-[#F9A825] h-4 w-4 text-[#F9A825] border-gray-300">
                        <span class="ml-2 text-gray-700">Particular (10%)</span>
                    </label>
                </div>
            </div>

            <div class="flex justify-end gap-3">
                <button id="cancel-client-info-button" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">
                    Cancelar
                </button>
                <button id="confirm-client-info-button" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">
                    Continuar
                </button>
            </div>
        </div>
    </div>
    <!-- FIN MODAL -->


    <script>
        // --- 1. REFERENCIAS A ELEMENTOS DEL DOM ---
        const importScreen = document.getElementById('import-screen');
        const calculatorScreen = document.getElementById('calculator-screen');
        const fileInput = document.getElementById('file-input');
        const productList = document.getElementById('product-list');
        const searchBox = document.getElementById('search-box');
        const errorMessage = document.getElementById('error-message');
        const clearDataButton = document.getElementById('clear-data-button');
        
        const cartItemsContainer = document.getElementById('cart-items');
        const cartPlaceholder = document.getElementById('cart-placeholder');
        const totalPriceEl = document.getElementById('total-price');
        const totalPriceVatEl = document.getElementById('total-price-vat');
        const totalProfitEl = document.getElementById('total-profit');
        const totalItemsEl = document.getElementById('total-items');
        const profitBox = document.getElementById('profit-box');
        const resetButton = document.getElementById('reset-button');
        const appManifest = document.getElementById('app-manifest');

        const budgetButton = document.getElementById('generate-budget-button');

        // Modal de Confirmación
        const confirmModalOverlay = document.getElementById('confirm-modal-overlay');
        const cancelClearButton = document.getElementById('cancel-clear-button');
        const confirmClearButton = document.getElementById('confirm-clear-button');

        // Modal de Ficha de Producto
        const productModalOverlay = document.getElementById('product-modal-overlay');
        const productModalContent = document.getElementById('product-modal-content');
        const closeModalButton = document.getElementById('close-modal-button');
        
        // Modal de Previo de Presupuesto
        const budgetPreviewModalOverlay = document.getElementById('budget-preview-modal-overlay');
        const budgetSheet = document.getElementById('budget-sheet');
        const closeBudgetPreviewButton = document.getElementById('close-budget-preview-button');
        const printBudgetButton = document.getElementById('print-budget-button');
        
        // Modal de Info Cliente
        const clientInfoModalOverlay = document.getElementById('client-info-modal-overlay');
        const cancelClientInfoButton = document.getElementById('cancel-client-info-button');
        const confirmClientInfoButton = document.getElementById('confirm-client-info-button');
        const clientNameInput = document.getElementById('client-name-input');


        // --- 2. ESTADO DE LA APLICACIÓN ---
        let allProducts = []; // Guarda todos los productos del Excel
        let cart = {}; // Guarda los productos seleccionados { productId: quantity }
        let currentTotalPrice = 0; // Para el previo
        let VAT_RATE = 0.21; // 21% de IVA (valor por defecto, se actualiza en el summary)

        // --- 3. LÓGICA DE INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', initializeApp);

        function initializeApp() {
            // Generar el manifiesto de la PWA dinámicamente
            const manifest = {
                "name": "Carjo Presupuestos",
                "short_name": "Carjo",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#f3f4f6",
                "theme_color": "#F9A825",
                "description": "Calculadora de presupuestos a partir de un Excel.",
                "icons": [
                    {
                        "src": "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22%23F9A825%22></circle><path d=%22M75 35H25a5 5 0 0 0-5 5v30a5 5 0 0 0 5 5h50a5 5 0 0 0 5-5V40a5 5 0 0 0-5-5zM30 48h40v-8H30zM30 58h40v-8H30zM50 25l25 10H25l25-10z%22 fill=%22%23ffffff%22></path></svg>",
                        "sizes": "192x192",
                        "type": "image/svg+xml"
                    }
                ]
            };
            const manifestString = JSON.stringify(manifest);
            appManifest.href = 'data:application/json;base64,' + btoa(unescape(encodeURIComponent(manifestString)));

            // Asignar listeners
            fileInput.addEventListener('change', handleFileSelect);
            resetButton.addEventListener('click', resetCalculator);
            searchBox.addEventListener('input', filterProducts);
            profitBox.addEventListener('click', toggleProfitVisibility);
            
            budgetButton.addEventListener('click', openClientInfoModal); 
            
            // Listeners del modal de confirmación
            clearDataButton.addEventListener('click', () => confirmModalOverlay.classList.remove('hidden'));
            cancelClearButton.addEventListener('click', () => confirmModalOverlay.classList.add('hidden'));
            confirmClearButton.addEventListener('click', clearAllData);
            
            // Listeners del modal de ficha de producto
            closeModalButton.addEventListener('click', () => productModalOverlay.classList.add('hidden'));
            productModalOverlay.addEventListener('click', (e) => {
                if (e.target === productModalOverlay) {
                    productModalOverlay.classList.add('hidden');
                }
            });
            
            // Listeners del modal de previo
            closeBudgetPreviewButton.addEventListener('click', () => budgetPreviewModalOverlay.classList.add('hidden'));
            printBudgetButton.addEventListener('click', () => window.print());

            // Listeners del modal de info cliente
            cancelClientInfoButton.addEventListener('click', () => clientInfoModalOverlay.classList.add('hidden'));
            confirmClientInfoButton.addEventListener('click', generateBudgetWithClientInfo);


            // Comprobar si hay productos guardados
            const savedProducts = localStorage.getItem('allProducts');
            const savedCart = localStorage.getItem('cart');

            if (savedProducts) {
                try {
                    allProducts = JSON.parse(savedProducts);
                    
                    if (savedCart) {
                        cart = JSON.parse(savedCart);
                    }
                    
                    displayProducts(allProducts); 
                    updateSummary(); // Asegurarse de que el resumen se actualiza con el IVA por defecto

                    importScreen.classList.add('hidden');
                    calculatorScreen.classList.remove('hidden');
                    calculatorScreen.classList.add('flex');
                } catch (e) {
                    console.error("Error al parsear datos de localStorage", e);
                    clearAllData();
                }
            }
        }
        
        // --- 4. LÓGICA DE LECTURA DE ARCHIVO ---

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.endsWith('.csv') && !file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                showError('Por favor, sube un archivo .csv o .xlsx');
                return;
            }
            
            errorMessage.classList.add('hidden');
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    parseData(jsonData);

                } catch (err) {
                    console.error(err);
                    showError('Error al procesar el archivo.');
                }
            };
            
            reader.onerror = function() {
                showError('No se pudo leer el archivo.');
            };
            
            reader.readAsArrayBuffer(file);
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function parseData(data) {
            allProducts = [];
            if (data.length < 2) {
                showError('El archivo está vacío o no tiene datos.');
                return;
            }

            const header = data[0].map(h => String(h).toLowerCase().trim());
            
            // Columnas obligatorias
            const nameIndex = header.indexOf('componente');
            const priceIndex = header.indexOf('precio pvp (€)');
            const costIndex = header.indexOf('coste tras descuentos');
            
            // Columnas opcionales
            const descIndex = header.indexOf('descripción');
            const brandIndex = header.indexOf('fabricante');
            const catIndex = header.indexOf('categoría');
            const imgIndex = header.indexOf('imagen_fabricante'); // <-- IMAGEN AÑADIDA

            if (nameIndex === -1 || priceIndex === -1 || costIndex === -1) {
                let missing = [];
                if (nameIndex === -1) missing.push('"componente"');
                if (priceIndex === -1) missing.push('"precio pvp (€)"');
                if (costIndex === -1) missing.push('"coste tras descuentos"');
                showError(`Faltan columnas requeridas: ${missing.join(', ')}.`);
                return;
            }

            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length === 0) continue;

                const nombre = row[nameIndex];
                const precioVenta = parseFloat(row[priceIndex]);
                const costo = parseFloat(row[costIndex]);

                if (nombre && !isNaN(precioVenta) && !isNaN(costo)) {
                    allProducts.push({
                        id: `prod-${i}`,
                        nombre: String(nombre).trim(),
                        precio: precioVenta,
                        costo: costo,
                        descripcion: descIndex > -1 ? String(row[descIndex] || '').trim() : '',
                        fabricante: brandIndex > -1 ? String(row[brandIndex] || '').trim() : '',
                        categoria: catIndex > -1 ? String(row[catIndex] || '').trim() : '',
                        imagen: imgIndex > -1 ? String(row[imgIndex] || '').trim() : '' // <-- IMAGEN AÑADIDA
                    });
                }
            }

            localStorage.setItem('allProducts', JSON.stringify(allProducts));
            cart = {};
            localStorage.removeItem('cart');
            displayProducts(allProducts);
            updateSummary(); 
            importScreen.classList.add('hidden');
            calculatorScreen.classList.remove('hidden');
            calculatorScreen.classList.add('flex');
        }

        // --- 5. LÓGICA DE RENDERIZADO (VISTAS) ---

        function displayProducts(productsToDisplay) {
            productList.innerHTML = '';
            
            if (productsToDisplay.length === 0) {
                productList.innerHTML = '<p class="col-span-full text-center text-gray-500">No se encontraron productos.</p>';
                return;
            }

            productsToDisplay.forEach(product => {
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-lg shadow-md flex items-center gap-4";
                
                const quantity = cart[product.id] || 0;
                // Usamos el IVA por defecto (21%) para la vista de lista
                const priceWithVat = product.precio * (1 + 0.21); 
                
                // --- IMAGEN AÑADIDA DE NUEVO ---
                let imgHtml = '';
                if (product.imagen) {
                    imgHtml = `<img src="${product.imagen}" alt="${product.fabricante}" class="w-14 h-14 object-contain rounded-md bg-gray-50 border p-1" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                               <div class="w-14 h-14 rounded-md bg-gray-100 flex items-center justify-center text-gray-400 border" style="display:none;">
                                   <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm1.5-6a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" /></svg>
                               </div>`;
                } else {
                    imgHtml = `<div class="w-14 h-14 rounded-md bg-gray-100 flex items-center justify-center text-gray-400 border">
                                   <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm1.5-6a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" /></svg>
                               </div>`;
                }
                // --- FIN IMAGEN AÑADIDA ---

                card.innerHTML = `
                    ${imgHtml}
                    <div class="flex-1 min-w-0">
                        <a href="#" class="block font-semibold text-gray-800 text-md truncate hover:underline" onclick="showProductModal(event, '${product.id}')">
                            ${product.nombre}
                        </a>
                        <div class"mt-1">
                            <p class="text-blue-600 font-semibold text-xs">
                                ${product.precio.toFixed(2)} € <span class="text-gray-500 font-normal">(Base)</span>
                            </p>
                            <p class="text-gray-900 font-bold text-md">
                                ${priceWithVat.toFixed(2)} € <span class="text-gray-600 font-normal text-xs">(IVA incl.)</span>
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button class="qty-btn bg-red-500" onclick="decrementQuantity(event, '${product.id}')">-</button>
                        <span id="qty-${product.id}" class="font-bold text-lg w-8 text-center">${quantity}</span>
                        <button class="qty-btn bg-green-600" onclick="incrementQuantity(event, '${product.id}')">+</button>
                    </div>
                `;
                
                productList.appendChild(card);
            });
        }

        function filterProducts() {
            const query = searchBox.value.toLowerCase();
            const filteredProducts = allProducts.filter(product => 
                product.nombre.toLowerCase().includes(query) ||
                (product.categoria && product.categoria.toLowerCase().includes(query)) ||
                (product.fabricante && product.fabricante.toLowerCase().includes(query))
            );
            displayProducts(filteredProducts);
        }
        
        function showProductModal(event, productId) {
            event.preventDefault(); 
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;
            
            // Usar 21% por defecto para la ficha de producto
            const priceWithVat = product.precio * (1 + 0.21); 
            
            let detailsHtml = '';
            if (product.fabricante) {
                detailsHtml += `<p class="text-md text-gray-600 mb-1"><span class="font-semibold">Fabricante:</span> ${product.fabricante}</p>`;
            }
            if (product.categoria) {
                detailsHtml += `<p class="text-md text-gray-600 mb-4"><span class="font-semibold">Categoría:</span> ${product.categoria}</p>`;
            }

            // --- IMAGEN AÑADIDA DE NUEVO A LA FICHA ---
            let imgHtml = '';
            if (product.imagen) {
                imgHtml = `<img src="${product.imagen}" alt="${product.fabricante}" class="w-full h-32 object-contain rounded-lg bg-gray-50 border p-2 mb-4" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                           <div class="w-full h-32 rounded-lg bg-gray-100 flex items-center justify-center text-gray-400 border mb-4" style="display:none;">
                               <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm1.5-6a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" /></svg>
                           </div>`;
            } else {
                imgHtml = `<div class="w-full h-32 rounded-lg bg-gray-100 flex items-center justify-center text-gray-400 border mb-4">
                               <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm1.5-6a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" /></svg>
                           </div>`;
            }
            // --- FIN IMAGEN AÑADIDA ---

            productModalContent.innerHTML = `
                ${imgHtml}
                <h2 class="text-2xl font-bold text-gray-900 mb-2">${product.nombre}</h2>
                ${detailsHtml}
                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                    <p class="text-blue-600 font-semibold text-sm">
                        ${product.precio.toFixed(2)} € <span class="text-gray-500 font-normal">(Base)</span>
                    </p>
                    <p class="text-gray-900 font-bold text-lg">
                        ${priceWithVat.toFixed(2)} € <span class="text-gray-600 font-normal text-sm">(IVA incl.)</span>
                    </p>
                </div>
                ${product.descripcion ? `
                    <h3 class="font-semibold text-gray-800 mb-2">Descripción</h3>
                    <p class="text-gray-600 whitespace-pre-wrap">${product.descripcion}</p>
                ` : ''}
            `;
            productModalOverlay.classList.remove('hidden');
        }


        // --- 6. LÓGICA DEL CARRITO ---

        function incrementQuantity(event, productId) {
            event.stopPropagation();
            const currentQty = cart[productId] || 0;
            cart[productId] = currentQty + 1;
            updateQuantityUI(productId);
            updateSummary();
        }

        function decrementQuantity(event, productId) {
            event.stopPropagation();
            const currentQty = cart[productId] || 0;
            if (currentQty > 0) {
                cart[productId] = currentQty - 1;
                if (cart[productId] === 0) {
                    delete cart[productId];
                }
            }
            updateQuantityUI(productId);
            updateSummary();
        }

        function updateQuantityUI(productId) {
            const qtyEl = document.getElementById(`qty-${productId}`);
            if (qtyEl) {
                qtyEl.textContent = cart[productId] || 0;
            }
        }

        function updateSummary() {
            let totalPrice = 0;
            let totalCost = 0;
            let totalItems = 0;
            
            // Usar 21% por defecto para el resumen, ya que no se ha elegido cliente
            const currentVatRate = 0.21; 

            cartItemsContainer.innerHTML = '';
            if (Object.keys(cart).length === 0) {
                cartItemsContainer.appendChild(cartPlaceholder);
                cartPlaceholder.classList.remove('hidden');
            } else {
                cartPlaceholder.classList.add('hidden');
                
                for (const productId in cart) {
                    const quantity = cart[productId];
                    if (quantity === 0) continue;
                    const product = allProducts.find(p => p.id === productId);
                    if (!product) continue;

                    totalPrice += product.precio * quantity;
                    totalCost += product.costo * quantity;
                    totalItems += quantity;
                    
                    // Usar 21% por defecto para la lista del carrito
                    const itemPriceVat = (product.precio * quantity) * (1 + currentVatRate); 

                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex justify-between items-center py-1 px-2 even:bg-gray-50 rounded';
                    itemEl.innerHTML = `
                        <span class="flex-1 min-w-0 pr-2">
                            <span class="font-semibold text-blue-600">${quantity}x</span> 
                            <span class="truncate">${product.nombre}</span>
                        </span>
                        <span class="font-medium text-right">
                            <span class="block text-blue-600 text-xs">${(product.precio * quantity).toFixed(2)} € <span class="text-gray-500">(Base)</span></span>
                            <span class="block text-gray-900 text-sm font-semibold">${itemPriceVat.toFixed(2)} € <span class="text-gray-600 text-xs">(IVA incl.)</span></span>
                        </span>
                    `;
                    cartItemsContainer.appendChild(itemEl);
                }
            }
            
            currentTotalPrice = totalPrice; // Guardar para el previo
            const totalProfit = totalPrice - totalCost; // CORRECCIÓN: Cálculo de totalProfit
            const totalPriceWithVat = totalPrice * (1 + currentVatRate);

            totalPriceEl.textContent = `${totalPrice.toFixed(2)} €`;
            totalPriceVatEl.textContent = `${totalPriceWithVat.toFixed(2)} €`;
            totalProfitEl.textContent = `${totalProfit.toFixed(2)} €`;
            totalItemsEl.textContent = totalItems;

            try {
                localStorage.setItem('cart', JSON.stringify(cart));
            } catch (e) {
                console.error("Error al guardar el carrito en localStorage", e);
            }
        }

        function resetCalculator() {
            cart = {};
            localStorage.removeItem('cart');
            updateSummary();
            filterProducts(); 
            profitBox.classList.add('censored'); 
        }

        function clearAllData() {
            confirmModalOverlay.classList.add('hidden');
            localStorage.removeItem('allProducts');
            localStorage.removeItem('cart');
            location.reload(); 
        }
        
        function toggleProfitVisibility() {
            profitBox.classList.toggle('censored');
        }
        
        // --- 7. LÓGICA: PREVIO DE PRESUPUESTO ---
        
        function openClientInfoModal() {
            if (Object.keys(cart).length === 0) {
                console.log("El carrito está vacío.");
                return;
            }
            clientNameInput.value = ''; // Limpiar el campo
            clientInfoModalOverlay.classList.remove('hidden');
        }
        
        function generateBudgetWithClientInfo() {
            const ivaRate = parseFloat(document.querySelector('input[name="iva-type"]:checked').value);
            let clientName = clientNameInput.value.trim();
            
            if (clientName === '') {
                clientName = 'Cliente'; // Valor por defecto
            }
            
            clientInfoModalOverlay.classList.add('hidden');
            showBudgetPreview(clientName, ivaRate);
        }
        
        function showBudgetPreview(clientName, ivaRate) {
            // Esta función usa currentTotalPrice, que se calcula en updateSummary()
            if (Object.keys(cart).length === 0) {
                return;
            }
            
            // Logo (PNG Data URI)
            const logo = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAADs0lEQVR4nO2dW27bMBAwVbVzB/EGOeUWeYI8QR/BTu8g3SBvEG8QbxBvkG+Qb5Bv0N2+gMBeiZQN6VA0W+kkh0RkRIqkkqR0fnx2Z8czkEREvn4REREREZHHgJg/E0iAG+C1s/o3AXwXgD8A+D6AeQDsA/gXwzmLf3cRkQ/AnwG8B+D7F8Dv2wH8WzM5y/35B8DxvQx/IwL4tJm85b4rBtA/APgwwP9rBH6pB+S+qwbQmAA+pvH/rwH8bwG5b5sBNCrArzX8vxLA/xKQ+7YYQGNCAH/X8P8agY9rkPuWEkBjAvhcw/+bAXz8gNyXGgBjQgD/1sD/VQL4LwK5LzUAxiQC+KqB/2sEftgCua8yAMYkAvg6gf+bAfxgB+RXKQBjEgH8VsP/qwTwyw7Ir1QBxCRKAD/V8P8agR9rkF+VAYhJpAA+T+D/JgB/tkF+lQYgJlEC+KmB/ysE8MsK5FdpAGKSDMAnBv6vEfhhB+RXKQBiigyAJwb+bwLwRwvkV2gAYpIMwCcG/q8R+GEH5FcpgJgkA/BJgf+bALxkA/IrFICYSALgSwb+rxH4YA/kVyDAYqIIgC8Z+L8JwC/ZIL9CAhCTYAB+b+D/KgF8yQb5FQhATCIB8HsD/zcB+EsW5FcgADEJBsDvDfyvEfjBDsjvUYAxSQXA7w383wTglWyQ36MAYpIKgN8b+L9KAF+yQX6NAhCTdAD+YOD/GgE/bIL8GgUgJskA/MHA/00AfsgG+TUKQEySAfiDgX8FAr5kg/waBSAm4QD8wcD/NQJ+2AT5NQpATMID+IOB/5sA/JEN8msegJjEAfjDgX8lAv5kg/yaiACYSAfgDwP/1wjoJkF+0wQgJvEAfjDwfxOAH7JBfssEIHImAfhhgP+rBPB/fSD3LTiAGCdPAD/M8P8agR9qkPuWH0CMkwngeyT+bwLwQwvkviUFEGNkAviThv9XCfzyA7lvKQHENEYAf9Lw/xoBH6ZA7ltGAHFMJoBvkfh/E4BfbpD7ljJADOObAHzI8P8qgV9ukPuWMkAcywPwtYb/1wjoIRfkviUEEMd5AvisgP+bAPy+BfkviQLEMc4AfNbA/1UCP2xA/kviADEscwD4rIb/1wh8yID8l0gA4ljmAHAk9H8TgN9sQP5LIgDEsYwB4Mjof5XAzzUgf/UTgBgWMwAcif6vEfghA/KvfgBiOMYAOCL/fwOAv2lA/qofgBgOMwAcEftXSgC/1kD+VT+AOBwOAEdi/9cI/GAF8q/6AcRh+ADgxwd/ZwF4ZQL5l0ZEREREREREPvEXl1m8F/JqY3wAAAAASUVORK5CYII=";
            
            let tableHtml = `<table id="budget-table">
                                <thead>
                                    <tr>
                                        <th>Cant.</th>
                                        <th>Descripción</th>
                                        <th class="text-right">P. Unit (Base)</th>
                                        <th class="text-right">Total (Base)</th>
                                    </tr>
                                </thead>
                                <tbody>`;
            
            let totalPrice = 0;
            for (const productId in cart) {
                const quantity = cart[productId];
                if (quantity === 0) continue;
                const product = allProducts.find(p => p.id === productId);
                if (!product) continue;

                const lineTotal = product.precio * quantity;
                totalPrice += lineTotal;
                
                // --- CAMBIO: Descripción del producto en la tabla ---
                let descHtml = product.descripcion 
                    ? `<br><span style="font-size: 11px; color: #666; font-weight: 400;">${product.descripcion}</span>` 
                    : '';

                tableHtml += `<tr>
                                <td>${quantity}</td>
                                <td>
                                    <strong style="font-size: 13px; color: #333;">${product.nombre}</strong>
                                    ${descHtml}
                                </td>
                                <td class="text-right">${product.precio.toFixed(2)} €</td>
                                <td class="text-right">${lineTotal.toFixed(2)} €</td>
                              </tr>`;
                // --- FIN DEL CAMBIO ---
            }
            
            tableHtml += `</tbody></table>`;
            
            // --- CAMBIO: Totales con nuevo diseño ---
            const vatAmount = totalPrice * ivaRate;
            const totalWithVat = totalPrice + vatAmount;
            
            const totalsHtml = `
                <div class="budget-totals-container">
                    <div class="totals-row">
                        <span>Total Base:</span>
                        <span>${totalPrice.toFixed(2)} €</span>
                    </div>
                    <div class="totals-row">
                        <span>IVA (${(ivaRate * 100).toFixed(0)}%):</span>
                        <span>${vatAmount.toFixed(2)} €</span>
                    </div>
                    <div class="totals-row final">
                        <span>TOTAL (IVA incl.):</span>
                        <span>${totalWithVat.toFixed(2)} €</span>
                    </div>
                </div>
            `;
            // --- FIN CAMBIO TOTALES ---

            // --- NUEVO: Pie de página del presupuesto ---
            const footerHtml = `
                <div class="budget-footer">
                    <p><strong>Forma de pago:</strong> 50% a la aceptación del presupuesto, 50% al finalizar la instalación.</p>
                    <p><strong>Garantía:</strong> Todos nuestros productos cuentan con 2 años de garantía según la legislación vigente.</p>
                    <p style="margin-top: 10px;">Gracias por su confianza en CARJO PUERTAS AUTOMATICAS.</p>
                </div>
            `;
            // --- FIN NUEVO PIE DE PÁGINA ---
            
            // --- Montar la hoja ---
            budgetSheet.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #F9A825; padding-bottom: 15px;">
                    <img src="${logo}" alt="Logo Carjo" style="width: 80px; height: 80px;" />
                    <div style="text-align: right;">
                        <h2 style="font-size: 28px; font-weight: 700; margin: 0; color: #111;">CARJO PUERTAS AUTOMATICAS</h2>
                        <p style="font-size: 14px; margin: 0; color: #555;">${new Date().toLocaleDateString('es-ES', { day: '2-digit', month: 'long', year: 'numeric' })}</p>
                    </div>
                </div>
                <div style="margin-top: 30px; margin-bottom: 10px;">
                    <h3 style="font-size: 12px; color: #888; text-transform: uppercase; margin-bottom: 5px;">Presupuesto para:</h3>
                    <p style="font-size: 18px; font-weight: 600; color: #111;">${clientName}</p>
                </div>
                ${tableHtml}
                ${totalsHtml}
                ${footerHtml}
            `;
            
            // Mostrar el modal
            budgetPreviewModalOverlay.classList.remove('hidden');
        }
        
    </script>
</body>
</html>

